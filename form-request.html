<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title id="page-title">REQUEST LIBUR / CUTI BULAN DEPAN</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/air-datepicker@3.5.0/air-datepicker.min.css">

<style>
body{
  font-family:'Segoe UI',sans-serif;margin:0;padding:20px;
  display:flex;justify-content:center;align-items:center;min-height:100vh;
  background:linear-gradient(135deg,#74ebd5,#ACB6E5);
}
.container{
  width:480px;max-width:100%;background:#fff;padding:35px 30px 45px;
  border-radius:18px;box-shadow:0 12px 30px rgba(0,0,0,0.15);
  animation:fadeIn .5s;
}
h2{
  text-align:center;margin-bottom:8px;font-size:23px;
  background:linear-gradient(90deg,#4e54c8,#8f94fb);
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;
}
#info-text{
  text-align:center;padding:12px;border-radius:10px;margin-bottom:20px;
  font-size:14px;background:#f0f4ff;border:1px solid #d2dbff;font-weight:600;
}
label{font-size:14px;font-weight:600;margin-bottom:6px;display:block;color:#444}
input,select{
  width:100%;padding:12px;border:1px solid #ddd;border-radius:10px;
  margin-bottom:15px;font-size:14px;background:#fafafa;
}
button{
  padding:14px;width:100%;background:linear-gradient(90deg,#11998e,#38ef7d);
  border:none;border-radius:12px;color:#fff;font-size:15px;font-weight:600;
  cursor:pointer;transition:.2s;
}
button:hover{transform:translateY(-2px)}
#status{
  margin-top:15px;font-size:13px;text-align:center;padding:6px;border-radius:8px;
}
.success{background:#d4edda;color:#155724;border:1px solid #b7dfb9}
.error{background:#f8d7da;color:#842029;border:1px solid #f1b0b7}
#countdown{text-align:center;margin-top:10px;font-weight:600;font-size:14px}
#loading{text-align:center;font-weight:600;margin-top:10px}
@keyframes fadeIn{from{opacity:0;transform:translateY(-10px)}to{opacity:1}}
</style>
</head>
<body>

<div class="container">
  <h2 id="header-text">REQUEST LIBUR / CUTI</h2>

  <div id="info-text">
    Silakan isi request sesuai kebutuhan.  
    Input bisa direvisi kapan saja, gunakan dengan bijak.
  </div>

  <div id="loading">⏳ Memuat data...</div>

  <form id="requestForm" style="display:none;">
    <label>NIK</label>
    <input type="text" id="nik" readonly>

    <label>Nama</label>
    <input type="text" id="nama" readonly>

    <label>Group</label>
    <input type="text" id="group" readonly>

    <label>Request Libur</label>
    <input type="text" id="libur" placeholder="Pilih tanggal" readonly>

    <label>Request Cuti</label>
    <input type="text" id="cuti" placeholder="Pilih tanggal" readonly>

    <label>Request Lainnya</label>
    <input type="text" id="requestLainnya" maxlength="80" placeholder="Jawaban singkat">

    <label>Ekstrakulikuler</label>
    <select id="ekstrakulikuler" required>
      <option value="">-- Pilih --</option>
      <option>FUTSAL</option>
      <option>BADMINTON</option>
      <option>FUTSAL & BADMINTON</option>
      <option>TIDAK MENGIKUTI</option>
    </select>

    <button type="submit">KIRIM REQUEST</button>
    <div id="status"></div>
    <div id="countdown"></div>
  </form>
</div>

<script src="https://cdn.jsdelivr.net/npm/air-datepicker@3.5.0/air-datepicker.min.js"></script>
<script>
/* ===================== CONFIG ===================== */
const scriptURL = "https://script.google.com/macros/s/AKfycbw-WhLaIfYV-Bw9461SlQ0quebn0zjeejj5E-U2LL9eNgWXE8-RZqtGrso2elTRI1Yz4w/exec";
const MAX_LIBUR = 9;

/* USER BYPASS FLAG */
let userBypass = false;

/* ===================== GET NIK FROM URL ===================== */
const qs = new URLSearchParams(location.search);
const nik = qs.get("nik") || "";
document.getElementById("nik").value = nik;

/* ===================== DATE HELPERS ===================== */
function toDates(str){
  if(!str) return [];
  return str.split(",").map(s=>{
    let [d,m]=s.trim().split("-").map(Number);
    return new Date(new Date().getFullYear(),m-1,d);
  });
}

/* ===================== INIT DATEPICKER ===================== */
function initPicker(id, disabled, pre){
  if(document.querySelector(id)._adp)
    document.querySelector(id)._adp.destroy();

  new AirDatepicker(id,{
    multipleDates:true,
    selectedDates:toDates(pre),
    disabledDates:disabled,
    dateFormat:"d-MM",
    multipleDatesSeparator:", ",
    autoClose:false
  });
}

/* ===================== TIMER ===================== */
function startCountdown(){
  const form = document.getElementById("requestForm");
  const cd   = document.getElementById("countdown");

  if(userBypass){
    cd.textContent = "✅ Anda memiliki akses bypass — Timer dinonaktifkan.";
    form.querySelectorAll("input,select,button").forEach(el=>el.disabled=false);
    return;
  }

  const now = new Date();
  const openDate  = new Date(now.getFullYear(),now.getMonth(),1,0,10,0);
  const closeDate = new Date(now.getFullYear(),now.getMonth(),16,23,59,59);

  function tick(){
    let t = new Date();
    if(t < openDate){
      form.querySelectorAll("input,select,button").forEach(el=>el.disabled=true);
      cd.textContent = "⏳ Belum dibuka.";
    }else if(t > closeDate){
      form.querySelectorAll("input,select,button").forEach(el=>el.disabled=true);
      cd.textContent = "⏰ Waktu request sudah berakhir.";
    }else{
      form.querySelectorAll("input,select,button").forEach(el=>el.disabled=false);
      cd.textContent = "";
    }
  }
  tick();
  setInterval(tick,1000);
}

/* ===================== BOOT ===================== */
(async function(){
  const loading = document.getElementById("loading");
  const form    = document.getElementById("requestForm");

  if(!nik){ loading.textContent="❌ NIK tidak ditemukan."; return; }

  try{
    const res = await fetch(`${scriptURL}?nik=${nik}`);
    const data = await res.json();

    document.getElementById("nama").value     = data.nama || "";
    document.getElementById("group").value    = data.group || "";
    document.getElementById("libur").value    = data.libur || "";
    document.getElementById("cuti").value     = data.cuti || "";
    document.getElementById("requestLainnya").value = data.requestLainnya || "";
    document.getElementById("ekstrakulikuler").value = data.ekstrakulikuler || "";

    /* READ BYPASS */
    userBypass = !!data.bypass;

    /* load disabled days */
    const res2 = await fetch(scriptURL);
    const fullDays = await res2.json();
    const disabledDates = fullDays.map(d =>
      new Date(new Date().getFullYear(), new Date().getMonth()+1, d)
    );

    initPicker("#libur", disabledDates, data.libur);
    initPicker("#cuti", disabledDates, data.cuti);

    loading.style.display="none";
    form.style.display="block";

    startCountdown();
  }catch(e){
    loading.textContent="❌ Error: "+e.message;
  }
})();

/* ===================== SUBMIT ===================== */
document.getElementById("requestForm").addEventListener("submit", async e=>{
  e.preventDefault();
  const st = document.getElementById("status");
  st.textContent="⏳ Mengirim..."; st.className="";

  const fd = new FormData();
  fd.append("nik", document.getElementById("nik").value);
  fd.append("nama", document.getElementById("nama").value);
  fd.append("group",document.getElementById("group").value);
  fd.append("libur",document.getElementById("libur").value);
  fd.append("cuti", document.getElementById("cuti").value);
  fd.append("requestLainnya",document.getElementById("requestLainnya").value);
  fd.append("ekstrakulikuler",document.getElementById("ekstrakulikuler").value);
  fd.append("return","json");

  try{
    const res = await fetch(scriptURL,{method:"POST",body:fd});
    const json = await res.json();

    if(json.status==="success"){
      st.textContent=json.message;
      st.className="success";
    }else{
      st.textContent=json.message || "Gagal.";
      st.className="error";
    }
  }catch(e){
    st.textContent="❌ Error mengirim: "+e.message;
    st.className="error";
  }
});
</script>

</body>
</html>

