<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title id="page-title">REQUEST LIBUR / CUTI JADWAL BULAN DEPAN</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/air-datepicker@3.5.0/air-datepicker.min.css">

<style>
body{
  font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;
  margin:0;
  min-height:100vh;
  display:flex;
  flex-direction:column;
  justify-content:center;
  align-items:center;
  background:linear-gradient(135deg,#74ebd5,#ACB6E5);
  padding:20px;
}
.container{
  background:#fff;
  padding:35px 30px 50px;
  border-radius:20px;
  box-shadow:0 12px 35px rgba(0,0,0,0.15);
  width:480px;max-width:100%;
  animation:fadeIn .6s ease-in-out;
  position:relative;
}
h2{
  text-align:center;margin-bottom:10px;font-size:24px;font-weight:700;
  background:linear-gradient(90deg,#4e54c8,#8f94fb);
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;
  letter-spacing:1px;
}
#info-text{font-size:14px;color:#333;text-align:center;margin-bottom:20px;line-height:1.5;padding:12px 15px;border-radius:12px;background:#f0f4ff;border:1px solid #c5d0ff;box-shadow:0 2px 8px rgba(0,0,0,.1);font-weight:600}
label{display:block;margin-bottom:6px;font-size:14px;font-weight:600;color:#444}
input,select{width:100%;padding:12px 14px;border:1px solid #ddd;border-radius:10px;font-size:14px;margin-bottom:16px;box-sizing:border-box;transition:all .3s ease;background:#fdfdfd}
input:focus,select:focus{border-color:#4e54c8;box-shadow:0 0 8px rgba(78,84,200,.3);background:#fff;outline:none}
input[readonly]{background:#f3f3f3;color:#555}
button[type="submit"]{width:100%;padding:14px;margin-top:5px;font-size:15px;font-weight:600;border:none;border-radius:12px;cursor:pointer;transition:all .3s ease;background:linear-gradient(90deg,#11998e,#38ef7d);color:#fff;box-shadow:0 6px 15px rgba(17,153,142,.35)}
button[type="submit"]:hover{transform:translateY(-2px);box-shadow:0 10px 20px rgba(17,153,142,.45)}
#status{margin-top:18px;text-align:center;font-size:14px;font-weight:500;min-height:28px;padding:6px;border-radius:8px}
.success{color:#155724;background:#d4edda;border:1px solid #c3e6cb}
.error{color:#721c24;background:#f8d7da;border:1px solid #f5c6cb}
#footer{font-size:13px;color:#666;text-align:center;margin-top:50px;line-height:1.5}
#footer-note{font-size:13px;color:#444;margin-bottom:10px;font-weight:600}
#countdown{font-weight:600;color:#333;margin-top:10px}
#copyright{text-align:center;font-size:12px;color:#333;opacity:.7;margin-top:25px;font-weight:600}
#loading{text-align:center;color:#333;font-weight:600;margin-top:10px;animation:fadeBlink 1.2s infinite}
@keyframes fadeBlink{0%,100%{opacity:.3}50%{opacity:1}}
@keyframes fadeIn{from{opacity:0;transform:translateY(-15px)}to{opacity:1;transform:translateY(0)}}
</style>
</head>
<body>

<div class="container">
  <h2 id="header-text">REQUEST LIBUR / CUTI JADWAL BULAN DEPAN</h2>

  <div id="info-text">
    Silakan Request Jadwal sesuai keperluan saja.<br>
    Inputan bisa direvisi / diganti berulang kali. Gunakan dengan bijak!
  </div>

  <div id="loading">‚è≥ Memuat data...</div>

  <form id="requestForm" style="display:none;">
    <label>NIK</label>
    <input type="text" id="nik" name="nik" readonly>

    <label>Nama</label>
    <input type="text" id="nama" name="nama" readonly>

    <label>Group</label>
    <input type="text" id="group" name="group" readonly>

    <label>Request Libur (Klik kotak input)</label>
    <input type="text" id="libur" name="libur" placeholder="Pilih tanggal libur" readonly>

    <label>Request Cuti (Klik kotak input)</label>
    <input type="text" id="cuti" name="cuti" placeholder="Pilih tanggal cuti" readonly>

    <label>Request Lainnya</label>
    <input type="text" id="requestLainnya" name="requestLainnya" placeholder="Jawaban singkat, maks 80 karakter" maxlength="80">

    <label>Ekstrakulikuler yang diikuti</label>
    <select id="ekstrakulikuler" name="ekstrakulikuler" required>
      <option value="">-- Pilih --</option>
      <option value="FUTSAL">FUTSAL</option>
      <option value="BADMINTON">BADMINTON</option>
      <option value="FUTSAL & BADMINTON">FUTSAL & BADMINTON</option>
      <option value="TIDAK MENGIKUTI">TIDAK MENGIKUTI</option>
    </select>

    <button type="submit" id="submitBtn">KIRIM REQUEST</button>
    <div id="status"></div>

    <div id="footer">
      <div id="footer-note"></div>
      <div id="countdown"></div>
    </div>
  </form>
</div>

<footer id="copyright">¬© 2025 EDP Fai</footer>

<script src="https://cdn.jsdelivr.net/npm/air-datepicker@3.5.0/air-datepicker.min.js"></script>
<script>
/* ===================== KONFIG ===================== */
const scriptURL       = "https://script.google.com/macros/s/AKfycbxubUfDUuHAVNPJuYJdg7nII7sXExRpWwxF0mLWCLrdLNBenN6qcW3t4uTjxEj2MmFq0Q/exec";
const MAX_KUOTA_HARIAN= 17;     // Info di UI (server = 17/18)
const MAX_LIBUR_USER  = 9;      // Batas per user untuk LIBUR
const monthNames = ["Januari","Februari","Maret","April","Mei","Juni","Juli","Agustus","September","Oktober","November","Desember"];

/* ===================== HEADER DINAMIS ===================== */
(function updateHeader(){
  const today = new Date();
  const nextMonth = new Date(today.getFullYear(), today.getMonth()+1, 1);
  const upperMonth = monthNames[nextMonth.getMonth()].toUpperCase();
  const headerText = `REQUEST LIBUR / CUTI BULAN ${upperMonth}`;
  document.getElementById('header-text').textContent = headerText;
  document.getElementById('page-title').textContent  = headerText;
  document.getElementById('footer-note').innerHTML =
    `Kuota libur bulan <b>${upperMonth}</b> 9 jika lembur 2, Lembur 1 10, Tidak lembur 11.<br>
     Untuk hari yg sudah full request maka tidak bisa direquest.`;
})();

/* ===================== PREFILL IDENTITAS dari URL ===================== */
const qs = new URLSearchParams(location.search);
const nikQS   = (qs.get('nik')   || '').trim();
const namaQS  = (qs.get('nama')  || '').trim();
const groupQS = (qs.get('group') || '').trim();
document.getElementById('nik').value   = nikQS;   // readonly
document.getElementById('nama').value  = namaQS;  // readonly
document.getElementById('group').value = groupQS; // readonly

/* ===================== HELPERS ===================== */
// Normalisasi tanggal dari berbagai format -> "d-MM"
function normalizeDateString(str){
  if(!str) return "";
  if(/^\d{1,2}-\d{1,2}(,\s*\d{1,2}-\d{1,2})*$/.test(str)) return str;
  if(Array.isArray(str)) return str.map(normalizeDateString).join(", ");
  if(typeof str==="string" && str.includes(",")){
    return str.split(",").map(s=>normalizeDateString(s.trim())).join(", ");
  }
  const d = new Date(str);
  if(!isNaN(d)) return `${d.getDate()}-${String(d.getMonth()+1).padStart(2,'0')}`;
  return String(str);
}
// String "d-MM, d-MM" -> array Date
function dmmStringToDates(str){
  if(!str) return [];
  const year = (new Date()).getFullYear();
  return str.split(",").map(s=>s.trim()).filter(Boolean).map(v=>{
    const m=v.match(/^(\d{1,2})-(\d{1,2})$/); if(!m) return null;
    return new Date(year, +m[2]-1, +m[1]);
  }).filter(Boolean);
}
// Build disabledDates dari array hari ["2","15"]
function buildDisabledDates(fullDays){
  const now = new Date();
  const y = now.getFullYear();
  const nextMonth = new Date(y, now.getMonth()+1, 1);
  if(!Array.isArray(fullDays)) return [];
  return fullDays.map(s=>{
    const t = String(s).trim();
    if(/^\d{1,2}$/.test(t)){
      return new Date(nextMonth.getFullYear(), nextMonth.getMonth(), +t);
    }else if(/^\d{1,2}-\d{1,2}$/.test(t)){
      const [dd,mm]=t.split("-").map(Number);
      return new Date(y, mm-1, dd);
    }
    return null;
  }).filter(Boolean);
}
// Hitung jumlah tanggal unik pada string "d-MM, d-MM" atau "d, d"
function countUniqueDates(str){
  if(!str) return 0;
  return new Set(str.split(",").map(s=>s.trim()).filter(Boolean)).size;
}

/* ===================== DATEPICKER ===================== */
function initDatepicker(selector, fullDays, preselectedStr){
  const el = document.querySelector(selector);
  if(el && el._adp){ el._adp.destroy(); }

  const disabledDates = buildDisabledDates(fullDays||[]);
  const now = new Date();
  const nextMonth = new Date(now.getFullYear(), now.getMonth()+1, 1);
  const isLibur = (selector === '#libur');
  const preselectedDates = dmmStringToDates(preselectedStr||"");

  const dp = new AirDatepicker(selector, {
    multipleDates: isLibur ? MAX_LIBUR_USER : true,
    multipleDatesSeparator: ', ',
    dateFormat: 'd-MM',
    disabledDates,
    locale:{
      days:['Minggu','Senin','Selasa','Rabu','Kamis','Jumat','Sabtu'],
      daysShort:['Min','Sen','Sel','Rab','Kam','Jum','Sab'],
      daysMin:['Mg','Sn','Sl','Rb','Km','Jm','Sb'],
      months:monthNames,
      monthsShort:monthNames.map(m=>m.substring(0,3)),
      today:'Hari Ini',
      clear:'Bersihkan',
      firstDay:1
    },
    minDate: nextMonth,
    maxDate: new Date(nextMonth.getFullYear(), nextMonth.getMonth()+1, 0),
    position:'bottom left',
    readOnly:true,
    selectedDates: preselectedDates,
    onSelect: ({ formattedDate })=>{
      if(!isLibur) return;
      const parts = (formattedDate||'').split(',').map(s=>s.trim()).filter(Boolean);
      if(parts.length>MAX_LIBUR_USER){
        const cut = dmmStringToDates(parts.slice(0,MAX_LIBUR_USER).join(', '));
        dp.clear(); dp.selectDate(cut);
        const status=document.getElementById('status');
        status.textContent=`‚ö†Ô∏è Maksimal memilih ${MAX_LIBUR_USER} tanggal libur.`; 
        status.className='error';
      }
    }
  });

  el._adp = dp;
}

/* ===================== PREFILL dari GAS ===================== */
function setFormValuesFromServer(payload){
  const data = payload?.data ? payload.data : payload || {};
  if(data.nik   != null) document.getElementById("nik").value   = data.nik;
  if(data.nama  != null) document.getElementById("nama").value  = data.nama;
  if(data.group != null) document.getElementById("group").value = data.group;

  const liburNorm = normalizeDateString(data.libur || "");
  const cutiNorm  = normalizeDateString(data.cuti  || "");
  const liburParts = liburNorm ? liburNorm.split(",").map(s=>s.trim()).filter(Boolean) : [];
  document.getElementById("libur").value = liburParts.slice(0, MAX_LIBUR_USER).join(", ");
  document.getElementById("cuti").value  = cutiNorm;

  document.getElementById("requestLainnya").value = data.requestLainnya || "";
  if(data.ekstrakulikuler){
    const eks=document.getElementById("ekstrakulikuler");
    const has=Array.from(eks.options).some(o=>o.value===data.ekstrakulikuler);
    if(has) eks.value=data.ekstrakulikuler;
  }
}

/* ===================== COUNTDOWN ===================== */
function startCountdown(){
  const now = new Date();
  const openDate  = new Date(now.getFullYear(), now.getMonth(), 1, 0,10,0);
  const closeDate = new Date(now.getFullYear(), now.getMonth(),16,23,59,59);
  const nextOpen  = new Date(now.getFullYear(), now.getMonth()+1, 1, 0,10,0);
  const el = document.getElementById("countdown");
  const form = document.getElementById("requestForm");

  function tick(){
    const cur=new Date(); let target,mode;
    if(cur<openDate){ target=openDate; mode="belum"; }
    else if(cur<=closeDate){ target=closeDate; mode="buka"; }
    else { target=nextOpen; mode="tutup"; }

    const diff=target-cur;
    const d=Math.floor(diff/86400000);
    const h=Math.floor(diff/3600000)%24;
    const m=Math.floor(diff/60000)%60;
    const s=Math.floor(diff/1000)%60;

    if(mode==="belum"){
      el.textContent=`‚è≥ Belum dibuka. Buka dalam: ${d}Hari ${h}Jam ${m}Menit ${s}Detik`;
      form.querySelectorAll("input, select, button").forEach(x=>x.disabled=true);
    }else if(mode==="buka"){
      el.textContent=`Sisa waktu request: ${d}Hari ${h}Jam ${m}Menit ${s}Detik`;
      form.querySelectorAll("input, select, button").forEach(x=>x.disabled=false);
    }else{
      el.textContent="‚è∞ Waktu request sudah berakhir. Open kembali tanggal 1‚Äì16 setiap bulan.";
      form.querySelectorAll("input, select, button").forEach(x=>x.disabled=true);
    }
  }
  tick(); setInterval(tick,1000);
}

/* ===================== BOOT ===================== */
(async function boot(){
  startCountdown();

  const nik = (document.getElementById('nik').value || '').trim();
  const loading = document.getElementById('loading');
  const form    = document.getElementById('requestForm');

  if(!nik){ loading.textContent = "‚ùå NIK tidak ditemukan di URL"; return; }

  try{
    // Prefill identitas/permintaan dari GAS jika ada
    const resUser = await fetch(`${scriptURL}?nik=${encodeURIComponent(nik)}`);
    if(resUser.ok){
      const data = await resUser.json();
      if(data && data.status==="found"){ setFormValuesFromServer(data); }
    }

    // Ambil tanggal full (kuota) -> disable
    const resDays = await fetch(scriptURL);
    const fullDays = resDays.ok ? await resDays.json() : [];

    // Inisialisasi datepicker dengan preselected dari input yang sudah diisi
    initDatepicker('#libur', fullDays, document.getElementById('libur').value);
    initDatepicker('#cuti',  fullDays, document.getElementById('cuti').value);

    loading.style.display="none";
    form.style.display="block";
  }catch(e){
    loading.textContent = "‚ùå Gagal memuat data: " + e.message;
  }
})();

/* ===================== SUBMIT ===================== */
document.getElementById("requestForm").addEventListener("submit", async function(e){
  e.preventDefault();
  const status = document.getElementById("status");
  status.textContent="‚è≥ Mengirim data..."; status.className="";

  // Urutkan tanggal "d-MM"
  function sortDates(str){
    if(!str) return "";
    const arr = str.split(",").map(s=>s.trim()).filter(Boolean);
    arr.sort((a,b)=>{
      const [da,ma]=a.split("-").map(Number);
      const [db,mb]=b.split("-").map(Number);
      return ma===mb ? da-db : ma-mb;
    });
    return Array.from(new Set(arr)).join(", ");
  }

  // üîπ BARU: buang bulan, hanya simpan tanggal ke sheet (contoh "2-03, 5-03" -> "2, 5")
  function stripMonth(str){
    if(!str) return "";
    return str.split(",").map(s=>s.trim()).filter(Boolean).map(v=>{
      // ambil angka di depan sebelum tanda "-"
      const m = v.match(/^(\d{1,2})/);
      return m ? m[1] : v;
    }).join(", ");
  }

  const liburInput=document.getElementById("libur");
  const cutiInput =document.getElementById("cuti");

  // sort dulu (berdasarkan d-MM), lalu konversi jadi tanggal saja
  liburInput.value = stripMonth(sortDates(liburInput.value));
  cutiInput.value  = stripMonth(sortDates(cutiInput.value));

  // Validasi batas tanggal libur
  const liburCount=countUniqueDates(liburInput.value);
  if(liburCount>MAX_LIBUR_USER){
    status.textContent=`‚ùå Maksimal memilih ${MAX_LIBUR_USER} tanggal libur. Anda memilih ${liburCount}.`;
    status.className="error"; return;
  }

  const formData = new FormData(this);
  formData.append("return","json");

  try{
    const res = await fetch(scriptURL,{method:"POST", body:formData});
    const ct  = res.headers.get("content-type") || "";
    if(ct.includes("application/json")){
      const payload = await res.json();
      if(payload.status==="success"){
        status.textContent="‚úÖ "+payload.message; status.className="success";
        setFormValuesFromServer(payload.data||{});

        // Refresh disabled dates setelah submit (mis. kuota berubah)
        const resDays = await fetch(scriptURL);
        const fullDays = resDays.ok ? await resDays.json() : [];
        initDatepicker('#libur', fullDays, document.getElementById('libur').value);
        initDatepicker('#cuti',  fullDays, document.getElementById('cuti').value);
      }else{
        status.textContent="‚ùå "+(payload.message||"Gagal mengirim data!"); status.className="error";
      }
    }else{
      const text = (await res.text()).trim();
      const m = text.match(/Gagal:\s*Kuota(?:\s+untuk)?\s*tanggal\s+([\d-]+)/i);
      if(m){
        status.textContent=`‚ùå Kuota penuh tanggal ${m[1]||"xx"} (maks ${MAX_KUOTA_HARIAN}).`;
        status.className="error";
      } else if(text.startsWith("Sukses")){
        status.textContent="‚úÖ "+text; status.className="success";
        // Prefill ulang via GET
        const nik = document.getElementById("nik").value.trim();
        try{
          const r = await fetch(`${scriptURL}?nik=${encodeURIComponent(nik)}`);
          const j = await r.json();
          if(j && j.status==="found") setFormValuesFromServer(j);
        }catch(_){}
      } else {
        status.textContent="‚ùå "+text; status.className="error";
      }
    }
  }catch(err){
    status.textContent="‚ùå Gagal mengirim data! Cek koneksi atau URL Web App";
    status.className="error";
  }
});
</script>
</body>
</html>



