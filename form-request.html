// ==========================================================================================
// --- KONFIGURASI GLOBAL ---
// ==========================================================================================
const SHEET_NAME = "JAWABAN"; // <=== NAMA SHEET ANDA ===
const SHEET_ID = "1C0QEWn7BlRTqaSvw01km0TIUIhQEJeR1c4y0BsY1Fz4"; // <=== ID SHEET ANDA ===

const NIK_COLUMN_INDEX = 2; // Kolom B (index 2)
const GROUP_COLUMN_INDEX = 4; // Kolom D (index 4)
const LIBUR_COLUMN_INDEX = 5; // Kolom E (index 5)
const CUTI_COLUMN_INDEX = 6; // Kolom F (index 6)

// LIMIT MAKSIMAL KUOTA PER HARI
const QUOTA_LIMIT = 21;


// ==========================================================================================
// --- FUNGSI HELPER (PEMBANTU) & KUOTA ---
// ==========================================================================================

function findRowByNIK(sheet, nik) {
  const START_DATA_ROW = 3; 
  const lastRow = sheet.getLastRow();
  if (lastRow < START_DATA_ROW) return -1;
    
  const range = sheet.getRange(START_DATA_ROW, NIK_COLUMN_INDEX, lastRow - START_DATA_ROW + 1, 1);
  const values = range.getValues();

  for (let i = 0; i < values.length; i++) {
    if (String(values[i][0]).trim() === String(nik).trim()) {
      return i + START_DATA_ROW; 
    }
  }
  return -1;
}

// Ambil hanya angka hari dari format d-MM (contoh: "21-11" â†’ "21")
function parseDays(dayString) {
  if (!dayString) return [];
  return String(dayString)
    .split(/,\s*|\s*,\s*/)
    .map(dmm => {
      const parts = dmm.trim().split('-');
      return parts[0]; 
    })
    .filter(d => d);
}

// Pengecekan ketat kuota sebelum simpan data
function checkQuotaStrict(sheet, liburInput, cutiInput, existingRow) {
  const requestedDays = [
    ...parseDays(liburInput),
    ...parseDays(cutiInput)
  ];

  const lastRow = sheet.getLastRow();
  if (lastRow < 3) return { allowed: true, blockedDay: null };
  
  const allRequests = sheet.getRange(3, LIBUR_COLUMN_INDEX, lastRow - 2, 2).getValues(); 
  const dayCounts = {}; 
  
  allRequests.forEach((row, index) => {
    const currentRow = index + 3; 
    if (existingRow !== -1 && currentRow === existingRow) {
      return; // lewati baris ini kalau sedang revisi
    }
    const libur = parseDays(row[0]);
    const cuti = parseDays(row[1]);
    [...libur, ...cuti].forEach(day => {
      if (day) {
        dayCounts[day] = (dayCounts[day] || 0) + 1;
      }
    });
  });

  for (const day of requestedDays) {
    if ((dayCounts[day] || 0) + 1 > QUOTA_LIMIT) {
      return { allowed: false, blockedDay: day };
    }
  }
  return { allowed: true, blockedDay: null };
}


// ==========================================================================================
// --- FUNGSI REVISI: AUTO SORT (Mulai dari Baris 3) ---
// ==========================================================================================

function autoSortByGroup(sheet) {
  const START_ROW = 3; 
  if (sheet.getLastRow() < START_ROW) return; 

  const range = sheet.getRange(
    START_ROW, 
    1, 
    sheet.getLastRow() - START_ROW + 1, 
    sheet.getLastColumn() 
  );

  range.sort({ column: GROUP_COLUMN_INDEX, ascending: true });
  SpreadsheetApp.flush(); 
}


// ==========================================================================================
// --- LOGIKA GET & POST (UTAMA) ---
// ==========================================================================================

function calculateFullDays() {
  const ss = SpreadsheetApp.openById(SHEET_ID);
  const sheet = ss.getSheetByName(SHEET_NAME);

  if (!sheet || sheet.getLastRow() < 3) return [];
  
  const lastRow = sheet.getLastRow();
  const allRequests = sheet.getRange(3, LIBUR_COLUMN_INDEX, lastRow - 2, 2).getValues(); 
  
  const dayCounts = {};
  const fullDays = new Set();
  
  allRequests.forEach(row => {
    const libur = parseDays(row[0]); 
    const cuti = parseDays(row[1]);
    [...libur, ...cuti].forEach(day => {
      if (day) {
        dayCounts[day] = (dayCounts[day] || 0) + 1;
        if (dayCounts[day] >= QUOTA_LIMIT) {
          fullDays.add(day); 
        }
      }
    });
  });

  return Array.from(fullDays);
}

function doGet(e) {
  try {
    const fullDays = calculateFullDays();
    const output = ContentService.createTextOutput(JSON.stringify(fullDays));
    output.setMimeType(ContentService.MimeType.JSON);
    output.setHeader('Access-Control-Allow-Origin', '*'); 
    return output;
  } catch (error) {
    Logger.log("Error in doGet (Quota Fetch): " + error.message);
    const output = ContentService.createTextOutput(JSON.stringify([])); 
    output.setMimeType(ContentService.MimeType.JSON);
    output.setHeader('Access-Control-Allow-Origin', '*'); 
    return output;
  }
}

function doPost(e) {
  if (!e || !e.parameter) {
    return ContentService.createTextOutput("Gagal: Tidak ada data parameter yang diterima.")
      .setMimeType(ContentService.MimeType.TEXT);
  }

  const data = e.parameter;
  
  // Validasi tanggal input (buka tgl 1 jam 00:10 s/d tutup tgl 16 jam 23:59)
  const now = new Date();
  const startDate = new Date(now.getFullYear(), now.getMonth(), 1, 0, 10, 0); 
  const expiredDate = new Date(now.getFullYear(), now.getMonth(), 16, 23, 59, 59);

  if (now < startDate) {
    return ContentService.createTextOutput("Gagal: Input belum dibuka (dimulai Tgl 1, 00:10).")
      .setMimeType(ContentService.MimeType.TEXT);
  }
  if (now > expiredDate) {
    return ContentService.createTextOutput("Gagal: Deadline input sudah terlewat (berakhir Tgl 16, 23:59).")
      .setMimeType(ContentService.MimeType.TEXT);
  }
  
  try {
    if (!data.nik || !data.nama) {
      return ContentService.createTextOutput("Gagal: NIK atau Nama kosong.")
        .setMimeType(ContentService.MimeType.TEXT);
    }

    const ss = SpreadsheetApp.openById(SHEET_ID);
    const sheet = ss.getSheetByName(SHEET_NAME);
    if (!sheet) {
      return ContentService.createTextOutput("Gagal: Sheet dengan nama '" + SHEET_NAME + "' tidak ditemukan.")
        .setMimeType(ContentService.MimeType.TEXT);
    }

    const existingRow = findRowByNIK(sheet, data.nik);
    const quotaCheck = checkQuotaStrict(sheet, data.libur, data.cuti, existingRow);
    if (!quotaCheck.allowed) {
      return ContentService
        .createTextOutput(`Gagal: Kuota untuk tanggal ${quotaCheck.blockedDay} sudah penuh (maksimal OFF ${QUOTA_LIMIT} user). Tidak dapat merevisi/menambah request.`)
        .setMimeType(ContentService.MimeType.TEXT);
    }

    const rowData = [
      new Date(),                 
      data.nik,                   
      data.nama,                  
      data.group || "",           
      data.libur || "",           
      data.cuti || "",            
      data.requestLainnya || "",  
      data.ekstrakulikuler || ""  
    ];

    let successMessage = "";
    if (existingRow !== -1) {
      const rangeToUpdate = sheet.getRange(existingRow, 1, 1, rowData.length);
      rangeToUpdate.setValues([rowData]); 
      successMessage = "Sukses: Revisi data NIK " + data.nik + " berhasil.";
    } else {
      sheet.appendRow(rowData);
      successMessage = "Sukses: Data baru NIK " + data.nik + " berhasil ditambahkan.";
    }

    autoSortByGroup(sheet);
    
    return ContentService.createTextOutput(successMessage).setMimeType(ContentService.MimeType.TEXT);

  } catch (err) {
    Logger.log("Error saat menyimpan/merevisi data: " + err.message);
    return ContentService
      .createTextOutput("Gagal: Terjadi kesalahan server. (" + err.message + ")")
      .setMimeType(ContentService.MimeType.TEXT);
  }
}
