<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title id="page-title">REQUEST LIBUR / CUTI JADWAL BULAN DEPAN</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/air-datepicker@3.5.0/air-datepicker.min.css">
<style>
body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;margin:0;min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px;background:linear-gradient(135deg,#74ebd5,#ACB6E5)}
.container{width:480px;max-width:100%;background:#fff;padding:32px;border-radius:16px;box-shadow:0 12px 30px rgba(0,0,0,.12)}
h2{text-align:center;margin:0 0 12px;font-size:22px;background:linear-gradient(90deg,#4e54c8,#8f94fb);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
label{display:block;margin-top:10px;font-weight:600;color:#333}
input,select{width:100%;padding:10px;border-radius:8px;border:1px solid #ddd;margin-top:8px;background:#fafafa}
button{width:100%;padding:12px;border-radius:10px;border:none;background:linear-gradient(90deg,#11998e,#38ef7d);color:#fff;margin-top:14px;font-weight:700;cursor:pointer}
#status{min-height:28px;margin-top:12px;text-align:center}
.success{background:#d4edda;color:#155724;padding:6px;border-radius:8px}
.error{background:#f8d7da;color:#842029;padding:6px;border-radius:8px}
#loading{text-align:center;margin-bottom:10px}
#countdown{text-align:center;margin-top:8px;font-weight:600}
.smallnote{font-size:13px;color:#555;margin-top:8px;text-align:center}
</style>
</head>
<body>
<div class="container" role="main" aria-labelledby="title">
  <h2 id="title">REQUEST LIBUR / CUTI BULAN DEPAN</h2>

  <div id="loading">⏳ Memuat data...</div>

  <form id="requestForm" style="display:none;">
    <label>NIK</label>
    <input type="text" id="nik" name="nik" readonly>

    <label>Nama</label>
    <input type="text" id="nama" name="nama" readonly>

    <label>Group</label>
    <input type="text" id="group" name="group" readonly>

    <label>Request Libur (klik untuk memilih)</label>
    <input type="text" id="libur" name="libur" placeholder="Pilih tanggal libur" readonly>

    <label>Request Cuti (klik untuk memilih)</label>
    <input type="text" id="cuti" name="cuti" placeholder="Pilih tanggal cuti" readonly>

    <label>Request Lainnya</label>
    <input type="text" id="requestLainnya" name="requestLainnya" maxlength="80" placeholder="Jawaban singkat (maks 80 karakter)">

    <label>Ekstrakulikuler</label>
    <select id="ekstrakulikuler" name="ekstrakulikuler">
      <option value="">-- Pilih --</option>
      <option value="FUTSAL">FUTSAL</option>
      <option value="BADMINTON">BADMINTON</option>
      <option value="FUTSAL & BADMINTON">FUTSAL & BADMINTON</option>
      <option value="TIDAK MENGIKUTI">TIDAK MENGIKUTI</option>
    </select>

    <button type="submit">KIRIM REQUEST</button>
    <div id="status" role="status"></div>
    <div id="countdown" aria-live="polite"></div>
    <div class="smallnote" id="bypassNote" style="display:none;color:#155724"></div>
  </form>
</div>

<script src="https://cdn.jsdelivr.net/npm/air-datepicker@3.5.0/air-datepicker.min.js"></script>
<script>
/* ===================== CONFIG ===================== */
// GANTI DENGAN WEB APP URL ANDA jika berbeda
const scriptURL = "https://script.google.com/macros/s/AKfycbw-WhLaIfYV-Bw9461SlQ0quebn0zjeejj5E-U2LL9eNgWXE8-RZqtGrso2elTRI1Yz4w/exec";

const MAX_LIBUR_USER = 8;

/* ===================== AMBIL NIK DARI URL ===================== */
const qs = new URLSearchParams(location.search);
const nikQS = (qs.get('nik') || '').trim();
document.getElementById('nik').value = nikQS;

/* ===================== HELPERS (parse hari-only dll) ===================== */
function parseDaysOnly(str){
  if(!str) return [];
  return String(str).split(',')
    .map(s=>s.trim()).filter(Boolean)
    .map(token=>{
      const m = token.match(/^(\d{1,2})(?:-\d{1,2})?$/);
      if(m) return Number(m[1]);
      const d = new Date(token);
      return isNaN(d) ? null : d.getDate();
    })
    .filter(n=>Number.isFinite(n)).map(n=>Number(n));
}
function daysArrayToString(arr){
  if(!Array.isArray(arr) || arr.length===0) return "";
  const uniq = Array.from(new Set(arr.map(n=>Number(n)).filter(n=>n>0 && n<=31)));
  return uniq.join(",");
}
function daysArrayToDisplay(arr){
  if(!Array.isArray(arr) || arr.length===0) return "";
  return Array.from(new Set(arr.map(n=>Number(n)).filter(n=>n>0 && n<=31))).join(", ");
}
function daysToDateObjects(str){
  const days = parseDaysOnly(str);
  if(days.length===0) return [];
  const now = new Date();
  const nextMonth = new Date(now.getFullYear(), now.getMonth()+1, 1);
  return days.map(d => new Date(nextMonth.getFullYear(), nextMonth.getMonth(), Number(d)));
}

/* ===================== DATEPICKER INIT ===================== */
function initDatepicker(selector, fullDaysArr, preselectedStr){
  const el = document.querySelector(selector);
  if(!el) return;
  if(el._adp) el._adp.destroy();

  const disabledDates = (Array.isArray(fullDaysArr) ? fullDaysArr : []).map(x=>{
    const day = Number(String(x).split('-')[0]);
    const now = new Date();
    return new Date(now.getFullYear(), now.getMonth()+1, day);
  });

  const dp = new AirDatepicker(selector, {
    multipleDates: true,
    selectedDates: daysToDateObjects(preselectedStr || ""),
    disabledDates,
    dateFormat: 'd-MM',
    multipleDatesSeparator: ', ',
    minDate: new Date(new Date().getFullYear(), new Date().getMonth()+1, 1),
    maxDate: new Date(new Date().getFullYear(), new Date().getMonth()+1, 0),
    position: 'bottom left',
    onSelect: ({ formattedDate })=>{
      if(selector === '#libur'){
        const parts = (formattedDate||'').split(',').map(s=>s.trim()).filter(Boolean);
        if(parts.length > MAX_LIBUR_USER){
          const selected = daysToDateObjects(parts.slice(0,MAX_LIBUR_USER).join(','));
          dp.clear(); dp.selectDate(selected);
          showStatus(`⚠️ Maksimal memilih ${MAX_LIBUR_USER} tanggal libur.`, 'error');
        } else {
          clearStatus();
        }
      }
    }
  });
  el._adp = dp;
}

/* ===================== UI status ===================== */
function showStatus(text, type){
  const s = document.getElementById('status');
  s.textContent = text || '';
  s.className = type === 'success' ? 'success' : (type === 'error' ? 'error' : '');
}
function clearStatus(){ showStatus('', null); }

/* ===================== PREFILL dari GAS (defensive) ===================== */
function setFormValuesFromServer(payload){
  // payload bisa: {status:'found', nik, nama, group, libur, cuti, ...}
  // atau langsung {nik,nama,group,...} atau {data:{...}}
  const src = payload && payload.data ? payload.data : (payload || {});
  // jika payload adalah array (fullDays), src akan jadi {} -> aman
  if(typeof src === 'object' && !Array.isArray(src)){
    if(src.nik != null) document.getElementById('nik').value = src.nik;
    if(src.nama != null) document.getElementById('nama').value = src.nama;
    if(src.group != null) document.getElementById('group').value = src.group;

    const liburDays = parseDaysOnly(src.libur || "");
    const cutiDays  = parseDaysOnly(src.cuti || "");
    document.getElementById('libur').value = daysArrayToDisplay(liburDays);
    document.getElementById('cuti').value  = daysArrayToDisplay(cutiDays);

    document.getElementById('requestLainnya').value = src.requestLainnya || "";
    if(src.ekstrakulikuler) document.getElementById('ekstrakulikuler').value = src.ekstrakulikuler;
  }
}

/* ===================== COUNTDOWN & BYPASS HANDLING ===================== */
let userBypass = false;
function startCountdownAndApplyBypass(){
  const el = document.getElementById('countdown');
  const form = document.getElementById('requestForm');

  function update(){
    // if bypass -> enable always
    if(userBypass === true){
      el.textContent = "✅ Anda memiliki akses khusus (bypass) — timer dinonaktifkan.";
      document.getElementById('bypassNote').style.display = 'block';
      document.getElementById('bypassNote').textContent = 'Akses bypass aktif untuk NIK ini.';
      form.querySelectorAll('input,select,button').forEach(i=>i.disabled=false);
      return;
    }

    // regular timer: buka tanggal 1–16 bulan berjalan
    const now = new Date();
    const open = new Date(now.getFullYear(), now.getMonth(), 1, 0, 10, 0);
    const close = new Date(now.getFullYear(), now.getMonth(), 16, 23, 59, 59);

    if(now < open){
      el.textContent = "⏳ Belum dibuka.";
      form.querySelectorAll('input,select,button').forEach(i=>i.disabled=true);
    } else if(now > close){
      el.textContent = "⏰ Waktu request sudah berakhir.";
      form.querySelectorAll('input,select,button').forEach(i=>i.disabled=true);
    } else {
      el.textContent = "";
      form.querySelectorAll('input,select,button').forEach(i=>i.disabled=false);
    }
  }
  update();
  setInterval(update, 1000);
}

/* ===================== BOOT (robust sequence) ===================== */
(async function boot(){
  const loading = document.getElementById('loading');
  const form = document.getElementById('requestForm');
  const nik = document.getElementById('nik').value.trim();
  if(!nik){
    loading.textContent = "❌ NIK tidak ditemukan di URL";
    return;
  }

  try{
    // 1) ambil data user (prefill + bypass info)
    console.log('Fetching user data for NIK', nik, 'from', scriptURL);
    const resUser = await fetch(`${scriptURL}?nik=${encodeURIComponent(nik)}`);
    if(!resUser.ok){
      const txt = await resUser.text();
      console.error('User fetch non-ok:', resUser.status, txt);
      loading.textContent = "❌ Gagal memuat identitas (server error). Cek console.";
      return;
    }
    const userJson = await resUser.json();
    console.log('User response:', userJson);

    // if GAS returns array (fullDays) mistakenly, we still proceed; setFormValuesFromServer handles that
    setFormValuesFromServer(userJson);

    // detect bypass flag if returned by your user-doGet
    if(userJson && (userJson.bypass === true || userJson.bypass === "1" || userJson.bypass === 1 || String(userJson.bypass).toLowerCase()==='true')){
      userBypass = true;
    } else if(userJson && userJson.data && (userJson.data.bypass === true || String(userJson.data.bypass).toLowerCase()==='1' || String(userJson.data.bypass).toLowerCase()==='true')){
      userBypass = true;
    } else {
      userBypass = false;
    }
    console.log('userBypass=', userBypass);

    // 2) ambil fullDays (list untuk disabledDates). server default GET tanpa param mengembalikan array fullDays
    const resDays = await fetch(scriptURL);
    let fullDays = [];
    if(resDays.ok){
      try{ fullDays = await resDays.json(); } catch(e){ fullDays = []; console.warn('Failed to parse fullDays as json', e); }
    } else {
      console.warn('fullDays fetch non-ok', resDays.status);
    }
    console.log('fullDays:', fullDays);

    // 3) init datepickers (preselected prefer server values)
    // server may return libur/cuti at top-level or inside data
    const preLibur = (userJson?.data?.libur) || userJson?.libur || document.getElementById('libur').value;
    const preCuti  = (userJson?.data?.cuti ) || userJson?.cuti  || document.getElementById('cuti').value;

    initDatepicker('#libur', fullDays, preLibur);
    initDatepicker('#cuti',  fullDays, preCuti);

    // 4) show form & hide loading
    loading.style.display = 'none';
    form.style.display = 'block';

    // 5) start countdown AFTER bypass known
    startCountdownAndApplyBypass();

    // if bypass, show small note
    if(userBypass){
      document.getElementById('bypassNote').style.display = 'block';
      document.getElementById('bypassNote').textContent = 'Akses bypass aktif untuk NIK ini.';
    } else {
      document.getElementById('bypassNote').style.display = 'none';
    }

  }catch(err){
    console.error('boot error', err);
    loading.textContent = "❌ Gagal memuat data: " + (err?.message || err);
  }
})();

/* ===================== SUBMIT: konversi ke hari saja sebelum kirim ===================== */
document.getElementById('requestForm').addEventListener('submit', async function(e){
  e.preventDefault();
  showStatus('⏳ Mengirim data...', null);

  try{
    const liburRaw = document.getElementById('libur').value;
    const cutiRaw  = document.getElementById('cuti').value;
    const liburArr = parseDaysOnly(liburRaw);
    const cutiArr  = parseDaysOnly(cutiRaw);

    if(liburArr.length > MAX_LIBUR_USER){
      showStatus(`❌ Maksimal memilih ${MAX_LIBUR_USER} tanggal libur. Anda memilih ${liburArr.length}.`, 'error');
      return;
    }

    const liburToSend = daysArrayToString(liburArr);
    const cutiToSend  = daysArrayToString(cutiArr);

    const fd = new FormData();
    fd.append('nik', document.getElementById('nik').value.trim());
    fd.append('nama', document.getElementById('nama').value.trim());
    fd.append('group', document.getElementById('group').value.trim());
    fd.append('libur', liburToSend);
    fd.append('cuti', cutiToSend);
    fd.append('requestLainnya', document.getElementById('requestLainnya').value.trim());
    fd.append('ekstrakulikuler', document.getElementById('ekstrakulikuler').value);
    fd.append('return', 'json');

    const res = await fetch(scriptURL, { method: 'POST', body: fd });
    const ct = res.headers.get('content-type') || '';
    if(ct.includes('application/json')){
      const json = await res.json();
      console.log('post result', json);
      if(json.status === 'success'){
        showStatus('✅ ' + json.message, 'success');
        if(json.data) setFormValuesFromServer(json.data);
        // refresh disabledDates and pickers
        const daysRes = await fetch(scriptURL);
        const fullDays = (daysRes.ok) ? await daysRes.json() : [];
        initDatepicker('#libur', fullDays, document.getElementById('libur').value);
        initDatepicker('#cuti',  fullDays, document.getElementById('cuti').value);
      } else {
        showStatus('❌ ' + (json.message || 'Gagal mengirim'), 'error');
      }
    } else {
      const text = (await res.text()).trim();
      showStatus('❌ ' + text, 'error');
    }
  }catch(err){
    console.error('submit error', err);
    showStatus('❌ Gagal mengirim data: ' + (err?.message || err), 'error');
  }
});
</script>
</body>
</html>
