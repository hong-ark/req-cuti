<script src="https://cdn.jsdelivr.net/npm/air-datepicker@3.5.0/air-datepicker.min.js"></script>
<script>
// URL Apps Script untuk submit form (POST URL)
const scriptURL = "https://script.google.com/macros/s/AKfycbz-mA_VSS-Msxy15QkCSIKvU3WCSPdbOKT5eV_hQs6VKoaWKthvTARUcuCMuCv-NB2I/exec";

// URL untuk mengambil kuota (GET URL). Sama dengan POST URL.
const quotaURL = scriptURL; 

// Ambil query params dari halaman sebelumnya
const params = new URLSearchParams(window.location.search);
document.getElementById("nik").value = params.get("nik") || "";
document.getElementById("nama").value = params.get("nama") || "";
document.getElementById("group").value = params.get("group") || "";

let fullDaysList = []; // Variabel global untuk menyimpan daftar hari yang penuh

// Fungsi untuk mengambil data kuota dari Apps Script
async function fetchFullDays() {
    try {
        const response = await fetch(quotaURL);
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        const data = await response.json();
        return data; // Mengembalikan array angka hari [3, 5, 12]
    } catch (error) {
        console.error("Gagal mengambil data kuota:", error);
        // Tetap lanjutkan dengan array kosong jika gagal
        return []; 
    }
}

// Inisialisasi datepicker
function initDatepicker(selector, disabledDays) {
    const today = new Date();
    const nextMonth = new Date(today.getFullYear(), today.getMonth() + 1, 1);
    
    // Konversi angka hari string ('5') menjadi objek Date yang utuh
    const disabledDates = disabledDays.map(day => {
        const date = new Date(nextMonth.getFullYear(), nextMonth.getMonth(), day);
        // Air-Datepicker membutuhkan objek Date untuk disabledDates
        return date; 
    });

    new AirDatepicker(selector, {
        multipleDates: true,
        multipleDatesSeparator: ', ',
        dateFormat: 'd', 
        
        // === BARU: Menonaktifkan tanggal yang kuotanya penuh ===
        disabledDates: disabledDates,
        // =======================================================
        
        locale: {
            days: ['Minggu','Senin','Selasa','Rabu','Kamis','Jumat','Sabtu'],
            daysShort: ['Min','Sen','Sel','Rab','Kam','Jum','Sab'],
            daysMin: ['Mg','Sn','Sl','Rb','Km','Jm','Sb'],
            months: ['Januari','Februari','Maret','April','Mei','Juni','Juli','Agustus','September','Oktober','November','Desember'],
            monthsShort: ['Jan','Feb','Mar','Apr','Mei','Jun','Jul','Agu','Sep','Okt','Nov','Des'],
            today: 'Hari Ini',
            clear: 'Bersihkan',
            dateFormat: 'dd/MM/yyyy',
            firstDay: 0
        },
        startDate: nextMonth,
        minDate: nextMonth,
        maxDate: new Date(nextMonth.getFullYear(), nextMonth.getMonth() + 1, 0),
        position: 'bottom left',
        readOnly: true
    });
}

// Fungsi utama yang dipanggil saat DOM siap
async function initializeApp() {
    // Tunggu data kuota diambil
    fullDaysList = await fetchFullDays();
    
    // Inisialisasi datepicker dengan daftar tanggal yang dinonaktifkan
    initDatepicker('#libur', fullDaysList);
    initDatepicker('#cuti', fullDaysList);
}

// Panggil fungsi inisialisasi
initializeApp();


// Submit form (LOGIKA TETAP SAMA)
document.getElementById("requestForm").addEventListener("submit", function(e){
  e.preventDefault();
  const status = document.getElementById("status");
  status.textContent = "⏳ Mengirim data...";
  status.className = "";

  const formData = new FormData(this);

  fetch(scriptURL, { method: "POST", body: formData })
    .then(res => res.text())
    .then(resText => {
      if(resText.trim().startsWith("Sukses")) { 
        status.textContent = "✅ " + resText.trim();
        status.className = "success";
        // Agar tanggal abu-abu diperbarui setelah submit
        setTimeout(initializeApp, 1000); 
      } else {
        const errorMsg = resText.includes("Gagal") ? resText : "Gagal mengirim data! (Respons Apps Script tidak valid)";
        status.textContent = `❌ ${errorMsg.substring(0, 100)}`;
        status.className = "error";
      }
    })
    .catch(err => {
      status.textContent = "❌ Gagal mengirim data! (Cek koneksi internet atau URL Web App)";
      status.className = "error";
    });
});
</script>
