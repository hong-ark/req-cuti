<script>
/* === KONFIGURASI SCRIPT === */
const scriptURL = "https://script.google.com/macros/s/AKfycbyrVWiH3HUNiNwdWR-AshygBO1yHv4ltdNeUgkcJS5ZyrBJsILxjRFjTd-YzXNTSUtF/exec";
const quotaURL = scriptURL;
const MAX_KUOTA_HARIAN = 21; // ✅ kuota maksimal per hari

// Deadline input → tanggal 16 jam 23:59 bulan berjalan
const DEADLINE_DAY = 16;
const DEADLINE_HOUR = 23;
const DEADLINE_MINUTE = 59;

let datepickerLibur = null;
let datepickerCuti = null;

const monthNames = ["Januari","Februari","Maret","April","Mei","Juni",
                    "Juli","Agustus","September","Oktober","November","Desember"];

/* === Fungsi untuk update judul halaman === */
(function updateHeader() {
  const today = new Date();
  const nextMonth = new Date(today.getFullYear(), today.getMonth() + 1, 1);
  const nextMonthName = monthNames[nextMonth.getMonth()];
  const headerText = `REQUEST LIBUR / CUTI BULAN ${nextMonthName.toUpperCase()}`;
  document.getElementById('header-text').textContent = headerText;
  document.getElementById('page-title').textContent = headerText;
})();

/* === Ambil parameter NIK, Nama, Group === */
const params = new URLSearchParams(window.location.search);
document.getElementById("nik").value = params.get("nik") || "";
document.getElementById("nama").value = params.get("nama") || "";
document.getElementById("group").value = params.get("group") || "";

/* === Cek Deadline === */
function checkDeadline() {
  const now = new Date();
  const deadline = new Date(now.getFullYear(), now.getMonth(), DEADLINE_DAY, DEADLINE_HOUR, DEADLINE_MINUTE, 59);

  if (now > deadline) {
    const form = document.getElementById("requestForm");
    const status = document.getElementById("status");
    Array.from(form.elements).forEach(el => el.disabled = true);
    status.textContent = `❌ Input ditutup sejak ${DEADLINE_DAY}/${now.getMonth()+1} ${DEADLINE_HOUR}:${DEADLINE_MINUTE}`;
    status.className = "error";
    return false;
  }
  return true;
}

/* === Fetch kuota penuh dari GAS === */
let fullDaysList = [];

async function fetchFullDays() {
  try {
    const response = await fetch(quotaURL);
    if (!response.ok) throw new Error(`HTTP error: ${response.status}`);
    return await response.json();
  } catch(e) {
    console.error("Gagal mengambil kuota:", e);
    return [];
  }
}

/* === Datepicker Setup === */
function initDatepicker(selector, disabledDays) {
  const today = new Date();
  const nextMonth = new Date(today.getFullYear(), today.getMonth() + 1, 1);
  const disabledDates = disabledDays.map(day => new Date(nextMonth.getFullYear(), nextMonth.getMonth(), parseInt(day)));

  if (document.querySelector(selector).datepicker) document.querySelector(selector).datepicker.destroy();

  const dp = new AirDatepicker(selector, {
    multipleDates: true,
    multipleDatesSeparator: ', ',
    dateFormat: 'd-MM', // contoh 1-11, 2-11
    disabledDates: disabledDates,
    locale: {
      days: ['Minggu','Senin','Selasa','Rabu','Kamis','Jumat','Sabtu'],
      daysShort: ['Min','Sen','Sel','Rab','Kam','Jum','Sab'],
      daysMin: ['Mg','Sn','Sl','Rb','Km','Jm','Sb'],
      months: monthNames,
      monthsShort: monthNames.map(m => m.substring(0, 3)),
      today: 'Hari Ini',
      clear: 'Bersihkan',
      dateFormat: 'dd/MM/yyyy',
      firstDay: 0
    },
    startDate: nextMonth,
    minDate: nextMonth,
    maxDate: new Date(nextMonth.getFullYear(), nextMonth.getMonth() + 1, 0),
    position: 'bottom left',
    readOnly: true
  });

  if (selector === '#libur') datepickerLibur = dp;
  else if (selector === '#cuti') datepickerCuti = dp;
}

async function initializeApp() {
  if (!checkDeadline()) return; // stop jika sudah lewat deadline
  fullDaysList = await fetchFullDays();
  initDatepicker('#libur', fullDaysList);
  initDatepicker('#cuti', fullDaysList);
}
initializeApp();

/* === Event Submit === */
document.getElementById("requestForm").addEventListener("submit", function(e){
  e.preventDefault();
  if (!checkDeadline()) return; // stop jika sudah lewat deadline

  const status = document.getElementById("status");
  status.textContent = "⏳ Mengirim data...";
  status.className = "";

  const formData = new FormData();
  formData.append('nik', document.getElementById("nik").value);
  formData.append('nama', document.getElementById("nama").value);
  formData.append('group', document.getElementById("group").value);
  formData.append('requestLainnya', document.getElementById("requestLainnya").value);
  formData.append('ekstrakulikuler', document.getElementById("ekstrakulikuler").value);
  formData.append('libur', document.getElementById("libur").value || "");
  formData.append('cuti', document.getElementById("cuti").value || "");

  fetch(scriptURL, { method: "POST", body: formData })
    .then(res=>res.text())
    .then(resText=>{
      if (resText.includes("Gagal: Kuota untuk tanggal") && resText.includes("sudah penuh")) {
        const match = resText.match(/tanggal\s+([\d-]+)\s+sudah/);
        const blockedDay = match ? match[1] : "xx";
        status.textContent = `❌ Kuota penuh tanggal ${blockedDay} (maks ${MAX_KUOTA_HARIAN}).`;
        status.className = "error";
      } else if(resText.trim().startsWith("Sukses")) {
        status.textContent = "✅ "+resText.trim();
        status.className = "success";
        setTimeout(initializeApp, 500);
      } else {
        status.textContent = "❌ "+(resText.includes("Gagal") ? resText : "Gagal mengirim data!");
        status.className = "error";
      }
    })
    .catch(()=>{
      status.textContent = "❌ Gagal mengirim data! Cek koneksi atau URL Web App";
      status.className = "error";
    });
});
</script>
