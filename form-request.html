<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title id="page-title">REQUEST LIBUR / CUTI BULAN DEPAN</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/air-datepicker@3.5.0/air-datepicker.min.css">

<style>
body{
  font-family:'Segoe UI',Tahoma,sans-serif;padding:20px;margin:0;
  background:linear-gradient(135deg,#74ebd5,#ACB6E5);
  display:flex;justify-content:center;align-items:center;min-height:100vh;
}
.container{
  width:480px;max-width:100%;background:white;padding:35px 30px 45px;
  border-radius:20px;box-shadow:0 12px 35px rgba(0,0,0,.15);
  animation:fadeIn .5s;
}
h2{
  text-align:center;margin-bottom:10px;font-size:24px;
  background:linear-gradient(90deg,#4e54c8,#8f94fb);
  -webkit-text-fill-color:transparent;-webkit-background-clip:text;
}
label{font-weight:600;margin-bottom:6px;display:block}
input,select{
  width:100%;padding:12px;margin-bottom:15px;border-radius:10px;
  border:1px solid #ccc;background:#fafafa;
}
button{
  width:100%;padding:14px;border:none;border-radius:12px;font-size:15px;
  background:linear-gradient(90deg,#11998e,#38ef7d);color:#fff;font-weight:600;
}
#status{text-align:center;margin-top:12px}
.success{background:#d4edda;color:#155724;padding:6px;border-radius:8px}
.error{background:#f8d7da;color:#842029;padding:6px;border-radius:8px}
#countdown{text-align:center;font-weight:600;margin-top:10px}
#loading{text-align:center;font-weight:600;margin:15px 0}
@keyframes fadeIn{from{opacity:0;transform:translateY(-10px)}to{opacity:1}}
</style>
</head>
<body>

<div class="container">
  <h2 id="header-text">REQUEST LIBUR / CUTI</h2>

  <div id="loading">⏳ Memuat data...</div>

  <form id="requestForm" style="display:none;">
    <label>NIK</label><input id="nik" readonly>
    <label>Nama</label><input id="nama" readonly>
    <label>Group</label><input id="group" readonly>

    <label>Request Libur</label>
    <input id="libur" placeholder="Tanggal libur" readonly>

    <label>Request Cuti</label>
    <input id="cuti" placeholder="Tanggal cuti" readonly>

    <label>Request Lainnya</label>
    <input id="requestLainnya" maxlength="80" placeholder="Jawaban singkat">

    <label>Ekstrakulikuler</label>
    <select id="ekstrakulikuler">
      <option value="">-- Pilih --</option>
      <option value="FUTSAL">FUTSAL</option>
      <option value="BADMINTON">BADMINTON</option>
      <option value="FUTSAL & BADMINTON">FUTSAL & BADMINTON</option>
      <option value="TIDAK MENGIKUTI">TIDAK MENGIKUTI</option>
    </select>

    <button type="submit">KIRIM REQUEST</button>
    <div id="status"></div>
    <div id="countdown"></div>
  </form>
</div>

<script src="https://cdn.jsdelivr.net/npm/air-datepicker@3.5.0/air-datepicker.min.js"></script>
<script>
/* =========================================
   KONFIG
========================================= */
const scriptURL = "https://script.google.com/macros/s/AKfycbw-WhLaIfYV-Bw9461SlQ0quebn0zjeejj5E-U2LL9eNgWXE8-RZqtGrso2elTRI1Yz4w/exec";
let userBypass = false;

/* ambil nik dari url */
const qs = new URLSearchParams(location.search);
const nik = qs.get("nik") || "";
document.getElementById("nik").value = nik;

/* ================= DATE HELPER ================= */
function toDates(str){
  if(!str) return [];
  return str.split(",").map(s=>{
    let [d,m] = s.trim().split("-").map(Number);
    return new Date(new Date().getFullYear(), m-1, d);
  });
}

function initPicker(id, disabled, pre){
  const el = document.querySelector(id);
  if(el._adp) el._adp.destroy();
  el._adp = new AirDatepicker(id, {
    multipleDates: true,
    selectedDates: toDates(pre),
    disabledDates: disabled,
    dateFormat: "d-MM",
    multipleDatesSeparator:", "
  });
}

/* ============= TIMER WITH BYPASS ============== */
function startCountdown(){
  const el = document.getElementById("countdown");
  const form = document.getElementById("requestForm");

  if(userBypass){
    form.querySelectorAll("input,select,button").forEach(e=>e.disabled=false);
    el.textContent = "✅ Akses BYPASS aktif — Timer dimatikan.";
    return;
  }

  const now = new Date();
  const open  = new Date(now.getFullYear(), now.getMonth(),1,0,10);
  const close = new Date(now.getFullYear(), now.getMonth(),16,23,59);

  function tick(){
    let t = new Date();

    if(t < open){
      el.textContent = "⏳ Belum dibuka.";
      form.querySelectorAll("input,select,button").forEach(e=>e.disabled=true);
    } else if(t > close){
      el.textContent = "⏰ Sudah ditutup.";
      form.querySelectorAll("input,select,button").forEach(e=>e.disabled=true);
    } else {
      el.textContent = "";
      form.querySelectorAll("input,select,button").forEach(e=>e.disabled=false);
    }
  }
  tick(); setInterval(tick,1000);
}

/* ================ BOOT ================= */
(async function loadData(){
  const loading = document.getElementById("loading");
  const form = document.getElementById("requestForm");

  if(!nik){ loading.textContent="❌ NIK kosong."; return; }

  try{
    const res = await fetch(`${scriptURL}?nik=${nik}`);
    const data = await res.json();

    document.getElementById("nama").value  = data.nama  || "";
    document.getElementById("group").value = data.group || "";
    document.getElementById("libur").value = data.libur || "";
    document.getElementById("cuti").value  = data.cuti  || "";
    document.getElementById("requestLainnya").value = data.requestLainnya || "";
    document.getElementById("ekstrakulikuler").value = data.ekstrakulikuler || "";

    /* baca BYPASS dari GAS */
    userBypass = !!data.bypass;

    /* retrieve full days */
    const res2 = await fetch(scriptURL);
    const fullDays = await res2.json();
    const disabledDates = fullDays.map(d =>
      new Date(new Date().getFullYear(), new Date().getMonth()+1, Number(d))
    );

    initPicker("#libur", disabledDates, data.libur);
    initPicker("#cuti", disabledDates, data.cuti);

    loading.style.display="none";
    form.style.display="block";

    startCountdown();
  }
  catch(e){
    loading.textContent = "❌ Error memuat: " + e.message;
  }
})();

/* ============ SUBMIT ============ */
document.getElementById("requestForm").addEventListener("submit", async e=>{
  e.preventDefault();
  const st = document.getElementById("status");
  st.textContent="⏳ Mengirim..."; st.className="";

  const fd = new FormData();
  fd.append("nik", document.getElementById("nik").value);
  fd.append("nama", document.getElementById("nama").value);
  fd.append("group",document.getElementById("group").value);
  fd.append("libur",document.getElementById("libur").value);
  fd.append("cuti", document.getElementById("cuti").value);
  fd.append("requestLainnya",document.getElementById("requestLainnya").value);
  fd.append("ekstrakulikuler",document.getElementById("ekstrakulikuler").value);
  fd.append("return","json");

  try{
    const res = await fetch(scriptURL,{method:"POST",body:fd});
    const j = await res.json();

    if(j.status==="success"){
      st.textContent=j.message; st.className="success";
    } else {
      st.textContent=j.message; st.className="error";
    }
  }
  catch(e){
    st.textContent="❌ Error: "+e.message;
    st.className="error";
  }
});
</script>

</body>
</html>
