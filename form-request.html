<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title id="page-title">REQUEST LIBUR / CUTI</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/air-datepicker@3.5.0/air-datepicker.min.css">

<style>
/* ====== STYLE (TIDAK DIUBAH) ====== */
body{
  font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;
  margin:0;min-height:100vh;
  display:flex;justify-content:center;align-items:center;
  background:linear-gradient(135deg,#74ebd5,#ACB6E5);
  padding:20px;
}
.container{
  background:#fff;padding:35px 30px 50px;border-radius:20px;
  box-shadow:0 12px 35px rgba(0,0,0,0.15);
  width:480px;max-width:100%;
}
h2{text-align:center;font-size:24px;font-weight:700}
label{display:block;margin-bottom:6px;font-weight:600}
input,select{
  width:100%;padding:12px;border-radius:10px;border:1px solid #ddd;
  margin-bottom:14px
}
input[readonly]{background:#f3f3f3}
button{
  width:100%;padding:14px;border:none;border-radius:12px;
  background:#38ef7d;font-weight:700;cursor:pointer
}
#status{text-align:center;margin-top:10px}
.success{color:#155724}
.error{color:#721c24}
#loading{text-align:center;font-weight:600}
</style>
</head>

<body>
<div class="container">
  <h2 id="header-text">REQUEST LIBUR / CUTI</h2>

  <div id="loading">⏳ Memuat data...</div>

  <form id="requestForm" style="display:none;">
    <label>NIK</label>
    <input id="nik" name="nik" readonly>

    <label>Nama</label>
    <input id="nama" name="nama" readonly>

    <label>Group</label>
    <input id="group" name="group" readonly>

    <label>Libur</label>
    <input id="libur" name="libur" readonly>

    <label>Cuti</label>
    <input id="cuti" name="cuti" readonly>

    <label>Request Lainnya</label>
    <input id="requestLainnya" name="requestLainnya" maxlength="80">

    <label>Ekstrakulikuler</label>
    <select id="ekstrakulikuler" name="ekstrakulikuler" required>
      <option value="">-- Pilih --</option>
      <option>FUTSAL</option>
      <option>BADMINTON</option>
      <option>FUTSAL & BADMINTON</option>
      <option>TIDAK MENGIKUTI</option>
    </select>

    <button type="submit">KIRIM</button>
    <div id="status"></div>
  </form>
</div>

<script src="https://cdn.jsdelivr.net/npm/air-datepicker@3.5.0/air-datepicker.min.js"></script>
<script>
/* ======================================================
   CONFIG MASTER (GANTI 1x SAJA)
====================================================== */
const CONFIG_SERVICE_URL = "https://script.google.com/macros/s/AKfycbyb737h9OZcfucP0W9t4ea7FyLUkrZ-QVNiR3PRatRW8jKpTU2sjmUb7BPuwfPyDlJB/exec";

/* ======================================================
   GLOBAL VAR
====================================================== */
let GAS_URL = "";
let MAX_KUOTA_HARIAN = 0;
let MAX_LIBUR_USER  = 0;

let lastLiburRaw = "";
let lastCutiRaw  = "";

/* ======================================================
   LOAD CONFIG
====================================================== */
async function loadConfig(){
  const r1 = await fetch(CONFIG_SERVICE_URL + "?mode=gasurl");
  const j1 = await r1.json();
  GAS_URL = j1.GAS_URL;

  const r2 = await fetch(GAS_URL + "?mode=config");
  const c  = await r2.json();
  MAX_KUOTA_HARIAN = Number(c.MAX_KUOTA_HARIAN);
  MAX_LIBUR_USER  = Number(c.MAX_LIBUR_USER);
}

/* ======================================================
   HELPERS
====================================================== */
const qs = new URLSearchParams(location.search);
nik.value   = qs.get("nik")||"";
nama.value  = qs.get("nama")||"";
group.value = qs.get("group")||"";

const monthNames=["JAN","FEB","MAR","APR","MEI","JUN","JUL","AGS","SEP","OKT","NOV","DES"];

function parseDays(s){
  return (s||"").split(",").map(x=>Number(x)).filter(n=>n>=1&&n<=31);
}
function daysToDates(arr){
  const n=new Date();const m=new Date(n.getFullYear(),n.getMonth()+1,1);
  return arr.map(d=>new Date(m.getFullYear(),m.getMonth(),d));
}

/* ======================================================
   DATEPICKER
====================================================== */
function initPicker(id,full,raw){
  const el=document.getElementById(id);
  if(el._adp) el._adp.destroy();

  el._adp=new AirDatepicker(el,{
    multipleDates:id==="libur"?MAX_LIBUR_USER:true,
    dateFormat:"d",
    selectedDates:daysToDates(parseDays(raw)),
    disabledDates:daysToDates(full||[])
  });
}

/* ======================================================
   BOOT
====================================================== */
(async()=>{
  try{
    await loadConfig();

    const u = await fetch(`${GAS_URL}?nik=${nik.value}`);
    const d = await u.json();
    if(d.status==="found"){
      lastLiburRaw=d.libur||"";
      lastCutiRaw=d.cuti||"";
      libur.value=lastLiburRaw;
      cuti.value=lastCutiRaw;
      requestLainnya.value=d.requestLainnya||"";
      ekstrakulikuler.value=d.ekstrakulikuler||"";
    }

    const r = await fetch(GAS_URL);
    const fullDays = await r.json();

    initPicker("libur",fullDays,lastLiburRaw);
    initPicker("cuti",fullDays,lastCutiRaw);

    loading.style.display="none";
    requestForm.style.display="block";
  }catch(e){
    loading.textContent="❌ "+e.message;
  }
})();

/* ======================================================
   SUBMIT
====================================================== */
requestForm.addEventListener("submit",async e=>{
  e.preventDefault();
  status.textContent="⏳ Mengirim...";

  if(parseDays(libur.value).length>MAX_LIBUR_USER){
    status.textContent=`❌ Maks ${MAX_LIBUR_USER} tanggal libur`;
    status.className="error";return;
  }

  const fd=new FormData(requestForm);
  fd.append("return","json");

  const r=await fetch(GAS_URL,{method:"POST",body:fd});
  const j=await r.json();

  if(j.status==="success"){
    status.textContent="✅ "+j.message;
    status.className="success";
  }else{
    status.textContent="❌ "+j.message;
    status.className="error";
  }
});
</script>
</body>
</html>
