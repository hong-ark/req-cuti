<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title id="page-title">REQUEST LIBUR / CUTI JADWAL BULAN DEPAN</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/air-datepicker@3.5.0/air-datepicker.min.css">
<style>
body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;margin:0;min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px;background:linear-gradient(135deg,#74ebd5,#ACB6E5)}
.container{width:480px;max-width:100%;background:#fff;padding:32px;border-radius:16px;box-shadow:0 12px 30px rgba(0,0,0,.12)}
h2{text-align:center;margin:0 0 12px;font-size:22px;background:linear-gradient(90deg,#4e54c8,#8f94fb);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
label{display:block;margin-top:10px;font-weight:600;color:#333}
input,select{width:100%;padding:10px;border-radius:8px;border:1px solid #ddd;margin-top:8px;background:#fafafa}
button{width:100%;padding:12px;border-radius:10px;border:none;background:linear-gradient(90deg,#11998e,#38ef7d);color:#fff;margin-top:14px;font-weight:700;cursor:pointer}
#status{min-height:28px;margin-top:12px;text-align:center}
.success{background:#d4edda;color:#155724;padding:6px;border-radius:8px}
.error{background:#f8d7da;color:#842029;padding:6px;border-radius:8px}
#loading{text-align:center;margin-bottom:10px}
#countdown{text-align:center;margin-top:8px;font-weight:600}
</style>
</head>
<body>
<div class="container">
  <h2 id="header-text">REQUEST LIBUR / CUTI BULAN DEPAN</h2>
  <div id="loading">⏳ Memuat data...</div>

  <form id="requestForm" style="display:none;">
    <label>NIK</label>
    <input type="text" id="nik" name="nik" readonly>

    <label>Nama</label>
    <input type="text" id="nama" name="nama" readonly>

    <label>Group</label>
    <input type="text" id="group" name="group" readonly>

    <label>Request Libur (Klik untuk memilih)</label>
    <input type="text" id="libur" name="libur" placeholder="Pilih tanggal libur" readonly>

    <label>Request Cuti (Klik untuk memilih)</label>
    <input type="text" id="cuti" name="cuti" placeholder="Pilih tanggal cuti" readonly>

    <label>Request Lainnya</label>
    <input type="text" id="requestLainnya" name="requestLainnya" maxlength="80" placeholder="Jawaban singkat (maks 80 karakter)">

    <label>Ekstrakulikuler</label>
    <select id="ekstrakulikuler" name="ekstrakulikuler">
      <option value="">-- Pilih --</option>
      <option value="FUTSAL">FUTSAL</option>
      <option value="BADMINTON">BADMINTON</option>
      <option value="FUTSAL & BADMINTON">FUTSAL & BADMINTON</option>
      <option value="TIDAK MENGIKUTI">TIDAK MENGIKUTI</option>
    </select>

    <button type="submit">KIRIM REQUEST</button>
    <div id="status"></div>
    <div id="countdown"></div>
  </form>
</div>

<script src="https://cdn.jsdelivr.net/npm/air-datepicker@3.5.0/air-datepicker.min.js"></script>
<script>
/* ===================== KONFIG ===================== */
const scriptURL = "https://script.google.com/macros/s/AKfycbw-WhLaIfYV-Bw9461SlQ0quebn0zjeejj5E-U2LL9eNgWXE8-RZqtGrso2elTRI1Yz4w/exec";
const MAX_LIBUR_USER = 8;
const monthNames = ["Januari","Februari","Maret","April","Mei","Juni","Juli","Agustus","September","Oktober","November","Desember"];

/* ===================== AMBIL NIK DARI URL ===================== */
const qs = new URLSearchParams(location.search);
const nikQS = (qs.get('nik')||'').trim();
document.getElementById('nik').value = nikQS;

/* ===================== UTIL HELPERS ===================== */
/** Parse input berbagai bentuk -> array angka hari [2,5,10] */
function parseDaysOnly(str){
  if(!str) return [];
  return String(str).split(',')
    .map(s=>s.trim()).filter(Boolean)
    .map(token=>{
      // if token "d-MM" -> extract the day part before '-'
      const m = token.match(/^(\d{1,2})(?:-\d{1,2})?$/);
      if(m) return Number(m[1]);
      // fallback try Date parse
      const d = new Date(token);
      return isNaN(d) ? null : d.getDate();
    })
    .filter(n=>Number.isFinite(n))
    .map(n=>Number(n));
}

/** Days array -> string "2,5,10" (no spaces) */
function daysArrayToString(arr){
  if(!Array.isArray(arr) || arr.length===0) return "";
  const uniq = Array.from(new Set(arr.map(n=>Number(n)).filter(n=>n>0 && n<=31)));
  return uniq.join(",");
}

/** Days array -> display string "2, 5, 10" (with spaces for UX) */
function daysArrayToDisplay(arr){
  if(!Array.isArray(arr) || arr.length===0) return "";
  return Array.from(new Set(arr.map(n=>Number(n)).filter(n=>n>0 && n<=31))).join(", ");
}

/** Convert "2,5" or "2-05,5-05" to Date objects in next month (for datepicker selectedDates) */
function daysToDateObjects(str){
  const days = parseDaysOnly(str);
  if(days.length===0) return [];
  const now = new Date();
  const nextMonth = new Date(now.getFullYear(), now.getMonth()+1, 1);
  return days.map(d => new Date(nextMonth.getFullYear(), nextMonth.getMonth(), Number(d)));
}

/* ===================== DATEPICKER ===================== */
function initDatepicker(selector, fullDaysArr, preselectedStr){
  const el = document.querySelector(selector);
  if(el && el._adp) el._adp.destroy();

  // convert fullDaysArr (array of "2" or "2-05") -> Date objects in next month
  const disabledDates = (Array.isArray(fullDaysArr) ? fullDaysArr : []).map(x=>{
    const day = Number(String(x).split('-')[0]);
    const now = new Date();
    return new Date(now.getFullYear(), now.getMonth()+1, day);
  });

  const dp = new AirDatepicker(selector, {
    multipleDates: true,
    selectedDates: daysToDateObjects(preselectedStr || ""),
    disabledDates,
    dateFormat: 'd-MM',
    multipleDatesSeparator: ', ',
    minDate: new Date(new Date().getFullYear(), new Date().getMonth()+1, 1),
    maxDate: new Date(new Date().getFullYear(), new Date().getMonth()+1, 0),
    position: 'bottom left',
    onSelect: ({ formattedDate })=>{
      // enforce MAX_LIBUR_USER only for libur field
      if(selector === '#libur'){
        const parts = (formattedDate||'').split(',').map(s=>s.trim()).filter(Boolean);
        if(parts.length > MAX_LIBUR_USER){
          // cut selection back to limit
          const selected = daysToDateObjects(parts.slice(0,MAX_LIBUR_USER).join(','));
          dp.clear(); dp.selectDate(selected);
          showStatus(`⚠️ Maksimal memilih ${MAX_LIBUR_USER} tanggal libur.`, 'error');
        } else {
          clearStatus();
        }
      }
      // Note: input will display d-MM; we'll convert to day-only on submit
    }
  });

  el._adp = dp;
}

/* ===================== UI HELPERS ===================== */
function showStatus(text, type){
  const s = document.getElementById('status');
  s.textContent = text || '';
  s.className = type === 'success' ? 'success' : (type === 'error' ? 'error' : '');
}
function clearStatus(){ showStatus('', null); }

/* ===================== PREFILL DARI SERVER ===================== */
function setFormValuesFromServer(payload){
  const src = payload && payload.data ? payload.data : payload || {};
  if(src.nik != null) document.getElementById('nik').value = src.nik;
  if(src.nama != null) document.getElementById('nama').value = src.nama;
  if(src.group != null) document.getElementById('group').value = src.group;

  // Normalize libur/cuti to days-only display
  const liburDays = parseDaysOnly(src.libur || "");
  const cutiDays  = parseDaysOnly(src.cuti  || "");
  document.getElementById('libur').value = daysArrayToDisplay(liburDays);
  document.getElementById('cuti').value  = daysArrayToDisplay(cutiDays);

  document.getElementById('requestLainnya').value = src.requestLainnya || "";
  if(src.ekstrakulikuler) document.getElementById('ekstrakulikuler').value = src.ekstrakulikuler;
}

/* ===================== COUNTDOWN (tanggal buka 1–16) ===================== */
function startCountdown(){
  const el = document.getElementById('countdown');
  const form = document.getElementById('requestForm');
  function tick(){
    const now = new Date();
    const open = new Date(now.getFullYear(), now.getMonth(), 1, 0, 10, 0);
    const close = new Date(now.getFullYear(), now.getMonth(), 16, 23, 59, 59);
    if(now < open){
      el.textContent = "⏳ Belum dibuka.";
      form.querySelectorAll("input,select,button").forEach(i=>i.disabled=true);
    } else if(now > close){
      el.textContent = "⏰ Waktu request sudah berakhir.";
      form.querySelectorAll("input,select,button").forEach(i=>i.disabled=true);
    } else {
      el.textContent = "";
      form.querySelectorAll("input,select,button").forEach(i=>i.disabled=false);
    }
  }
  tick(); setInterval(tick,1000);
}

/* ===================== BOOT ===================== */
(async function boot(){
  const loading = document.getElementById('loading');
  const form = document.getElementById('requestForm');
  const nik = document.getElementById('nik').value.trim();
  if(!nik){ loading.textContent = "❌ NIK tidak ditemukan di URL"; return; }

  try{
    // prefill data for nik
    const resUser = await fetch(`${scriptURL}?nik=${encodeURIComponent(nik)}`);
    const data = await resUser.json();
    setFormValuesFromServer(data);

    // get fullDays (disabled) from server
    const resDays = await fetch(scriptURL);
    const fullDays = resDays.ok ? await resDays.json() : [];

    // For datepicker preselected, prefer server's raw values (may be d-MM or day-only)
    const preLibur = (data?.data?.libur || data?.libur) || document.getElementById('libur').value;
    const preCuti  = (data?.data?.cuti  || data?.cuti)  || document.getElementById('cuti').value;

    initDatepicker('#libur', fullDays, preLibur);
    initDatepicker('#cuti',  fullDays, preCuti);

    loading.style.display = 'none';
    form.style.display = 'block';

    startCountdown();
  }catch(err){
    loading.textContent = "❌ Gagal memuat data: " + (err.message || err);
    console.error(err);
  }
})();

/* ===================== SUBMIT: KONVERSI KE HARI-SAJA SEBELUM KIRIM ===================== */
document.getElementById('requestForm').addEventListener('submit', async function(e){
  e.preventDefault();
  showStatus('⏳ Mengirim data...', null);

  try{
    // The inputs (#libur and #cuti) may contain:
    // - day-only display "2, 5, 10"
    // - or date-format "2-12, 5-12"
    // -> parseDaysOnly will extract day numbers
    const liburInputRaw = document.getElementById('libur').value;
    const cutiInputRaw  = document.getElementById('cuti').value;

    const liburDaysArr = parseDaysOnly(liburInputRaw);
    const cutiDaysArr  = parseDaysOnly(cutiInputRaw);

    // validate per-user libur limit
    if(liburDaysArr.length > MAX_LIBUR_USER){
      showStatus(`❌ Maksimal memilih ${MAX_LIBUR_USER} tanggal libur. Anda memilih ${liburDaysArr.length}.`, 'error');
      return;
    }

    const liburToSend = daysArrayToString(liburDaysArr); // "2,5,10"
    const cutiToSend  = daysArrayToString(cutiDaysArr);

    const fd = new FormData();
    fd.append('nik', document.getElementById('nik').value.trim());
    fd.append('nama', document.getElementById('nama').value.trim());
    fd.append('group', document.getElementById('group').value.trim());
    fd.append('libur', liburToSend);
    fd.append('cuti', cutiToSend);
    fd.append('requestLainnya', document.getElementById('requestLainnya').value.trim());
    fd.append('ekstrakulikuler', document.getElementById('ekstrakulikuler').value);
    fd.append('return','json');

    const res = await fetch(scriptURL, { method: 'POST', body: fd });
    const ct = res.headers.get('content-type') || '';
    if(ct.includes('application/json')){
      const json = await res.json();
      if(json.status === 'success'){
        showStatus('✅ ' + json.message, 'success');
        if(json.data) setFormValuesFromServer(json.data);
        // refresh disabled dates & pickers
        const resDays = await fetch(scriptURL);
        const fullDays = resDays.ok ? await resDays.json() : [];
        initDatepicker('#libur', fullDays, document.getElementById('libur').value);
        initDatepicker('#cuti',  fullDays, document.getElementById('cuti').value);
      } else {
        showStatus('❌ ' + (json.message || 'Gagal mengirim'), 'error');
      }
    } else {
      const text = (await res.text()).trim();
      showStatus('❌ ' + text, 'error');
    }
  }catch(err){
    showStatus('❌ Gagal mengirim data: ' + (err.message || err), 'error');
    console.error(err);
  }
});
</script>
</body>
</html>
