<script>
/* ================= KONFIG ================= */
const MASTER_GAS_URL =
  "https://script.google.com/macros/s/AKfycby1XWMOjxdQXNqkNpKtayd0c55ZK3VkQvaZ_KSqibEUBjExlvaVUzunpfe4_HPnDX1q/exec";

/* ================= UTIL ================= */
function statusEl(){
  const el=document.getElementById("status");
  return (msg,err)=>{
    el.textContent=msg;
    el.className=err?"error":"success";
  };
}

// normalisasi SPECIAL_HOLIDAYS ‚Üí STRING MURNI
function normalizeHolidayString(str){
  if(!str) return "";
  return str
    .split(",")
    .map(s=>s.trim())
    .filter(s=>/^\d{4}-\d{2}-\d{2}$/.test(s))
    .join(",");
}

/* ================= LOAD ================= */
async function loadConfig(){
  const status = statusEl();
  status("‚è≥ Memuat master config...");

  try{
    const r = await fetch(MASTER_GAS_URL + "?mode=getMasterConfig");
    const cfg = await r.json();

    gasUrl.value = cfg.GAS_URL || "";

    if(!cfg.GAS_URL){
      status("‚ö†Ô∏è GAS_URL belum di-set", true);
      return;
    }

    const r2 = await fetch(cfg.GAS_URL + "?mode=config");
    const s = await r2.json();

    curMaxHarian.value = s.MAX_KUOTA_HARIAN ?? "-";
    curMaxUser.value   = s.MAX_LIBUR_USER ?? "-";
    curHoliday.value   = s.SPECIAL_HOLIDAYS || "-";

    newMaxHarian.value = s.MAX_KUOTA_HARIAN ?? "";
    newMaxUser.value   = s.MAX_LIBUR_USER ?? "";
    newHoliday.value   = s.SPECIAL_HOLIDAYS || "";

    status("‚úîÔ∏è Setting aktif dimuat");
  }catch(e){
    status("‚ùå Gagal load config", true);
  }
}

/* ================= SAVE ================= */
async function saveConfig(){
  const status = statusEl();
  const url = gasUrl.value.trim();
  if(!url){
    status("‚ùå URL GAS wajib", true);
    return;
  }

  // üîê NORMALISASI HOLIDAY
  const holidayStr = normalizeHolidayString(newHoliday.value);

  if(newHoliday.value && !holidayStr){
    status("‚ùå Format tanggal salah. Gunakan YYYY-MM-DD", true);
    return;
  }

  status("‚è≥ Menyimpan...");

  try{
    // simpan GAS_URL ke MASTER
    const fd1 = new FormData();
    fd1.append("mode","saveMasterConfig");
    fd1.append("GAS_URL",url);
    await fetch(MASTER_GAS_URL,{method:"POST",body:fd1});

    // simpan setting ke GAS JAWABAN
    const fd2 = new FormData();
    fd2.append("mode","saveConfig");
    fd2.append("MAX_KUOTA_HARIAN", newMaxHarian.value);
    fd2.append("MAX_LIBUR_USER", newMaxUser.value);
    fd2.append("SPECIAL_HOLIDAYS", holidayStr);
    await fetch(url,{method:"POST",body:fd2});

    status("‚úÖ Setting tersimpan & aktif");
    loadConfig();
  }catch(e){
    status("‚ùå Gagal menyimpan", true);
  }
}

/* ================= INIT ================= */
loadConfig();
</script>
